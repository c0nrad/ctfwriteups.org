import { Subject, timer, of } from 'rxjs';
import { map, switchMap, take, tap, startWith, shareReplay } from 'rxjs/operators';
export class LoadingBarState {
    constructor(config = {}) {
        this.config = config;
        this.state = {
            action: null,
            value: 0,
            initialValue: 0,
        };
        this.requests = null;
        this.disabled = false;
        this.stream$ = new Subject();
        this._value$ = null;
        this.timer$ = (s) => {
            let state$ = of(s);
            switch (s.action) {
                case 'start':
                case 'increment':
                case 'set': {
                    if (s.action === 'start' && this.config.latencyThreshold === 0 && s.value === 0) {
                        s.value = s.initialValue;
                    }
                    if (this.requests > 0) {
                        state$ = timer(this.config.latencyThreshold, 250).pipe(map((t) => ({ ...s, value: t === 0 ? this.state.value || s.initialValue : this._increment() })));
                    }
                    break;
                }
                case 'complete':
                case 'stop': {
                    // Attempt to aggregate any start/complete calls within 500ms:
                    state$ =
                        s.value === 0
                            ? of({ ...s })
                            : timer(0, 500).pipe(take(2), map((t) => ({ value: t === 0 ? 100 : 0 })));
                    break;
                }
            }
            return state$.pipe(map((next) => ({ ...next, action: 'set' })), tap((next) => this.next(next, false)));
        };
        this.config = {
            latencyThreshold: 0,
            ...config,
        };
    }
    get value$() {
        if (this._value$) {
            return this._value$;
        }
        return (this._value$ = this.stream$.pipe(startWith(this.state), switchMap((s) => this.timer$(s)), shareReplay(), map((s) => s.value)));
    }
    start(initialValue = 2) {
        if (this.disabled) {
            return;
        }
        this.next({ action: 'start', initialValue });
    }
    stop() {
        this.next({ action: 'stop' });
    }
    complete() {
        this.next({ action: 'complete' });
    }
    disable() {
        this.disabled = true;
    }
    set(value) {
        this.next({ action: 'set', value });
    }
    increment(value = 0) {
        this.next({ action: 'increment', value });
    }
    next(state, emitEvent = true) {
        switch (state.action) {
            case 'start':
                this.requests = (this.requests || 0) + 1;
                break;
            case 'complete':
                this.requests = (this.requests || 1) - 1;
                if (this.requests > 0) {
                    return;
                }
                break;
            case 'stop':
                this.requests = 0;
                break;
            case 'increment':
                state.value = this._increment(state.value);
                break;
        }
        this.state = { ...this.state, action: null, ...state };
        if (emitEvent) {
            this.stream$.next(this.state);
        }
    }
    _increment(rnd = 0) {
        const stat = this.state.value;
        if (stat >= 99) {
            rnd = 0;
        }
        if (rnd === 0) {
            if (stat >= 0 && stat < 25) {
                // Start out between 3 - 6% increments
                rnd = Math.random() * (5 - 3 + 1) + 3;
            }
            else if (stat >= 25 && stat < 65) {
                // increment between 0 - 3%
                rnd = Math.random() * 3;
            }
            else if (stat >= 65 && stat < 90) {
                // increment between 0 - 2%
                rnd = Math.random() * 2;
            }
            else if (stat >= 90 && stat < 99) {
                // finally, increment it .5 %
                rnd = 0.5;
            }
            else {
                // after 99%, don't increment:
                rnd = 0;
            }
        }
        return rnd + stat;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy1iYXIuc3RhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9sb2FkaW5nLWJhci5zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFTbkYsTUFBTSxPQUFPLGVBQWU7SUFXMUIsWUFBb0IsU0FBMkIsRUFBRTtRQUE3QixXQUFNLEdBQU4sTUFBTSxDQUF1QjtRQVZ6QyxVQUFLLEdBQXFCO1lBQ2hDLE1BQU0sRUFBRSxJQUFJO1lBQ1osS0FBSyxFQUFFLENBQUM7WUFDUixZQUFZLEVBQUUsQ0FBQztTQUNoQixDQUFDO1FBQ00sYUFBUSxHQUFHLElBQUksQ0FBQztRQUNoQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ1IsWUFBTyxHQUFHLElBQUksT0FBTyxFQUFvQixDQUFDO1FBQ25ELFlBQU8sR0FBOEIsSUFBSSxDQUFDO1FBMkUxQyxXQUFNLEdBQUcsQ0FBQyxDQUFtQixFQUFFLEVBQUU7WUFDdkMsSUFBSSxNQUFNLEdBQTBDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxRCxRQUFRLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hCLEtBQUssT0FBTyxDQUFDO2dCQUNiLEtBQUssV0FBVyxDQUFDO2dCQUNqQixLQUFLLEtBQUssQ0FBQyxDQUFDO29CQUNWLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxPQUFPLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLEVBQUU7d0JBQy9FLENBQUMsQ0FBQyxLQUFLLEdBQUcs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SUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQXVDTyxVQUFVLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDeEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDOUIsSUFBSSxJQUFJLElBQUksRUFBRSxFQUFFO1lBQ2QsR0FBRyxHQUFHLENBQUMsQ0FBQztTQUNUO1FBRUQsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO1lBQ2IsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxFQUFFLEVBQUU7Z0JBQzFCLHNDQUFzQztnQkFDdEMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZDO2lCQUFNLElBQUksSUFBSSxJQUFJLEVBQUUsSUFBSSxJQUFJLEdBQUcsRUFBRSxFQUFFO2dCQUNsQywyQkFBMkI7Z0JBQzNCLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2FBQ3pCO2lCQUFNLElBQUksSUFBSSxJQUFJLEVBQUUsSUFBSSxJQUFJLEdBQUcsRUFBRSxFQUFFO2dCQUNsQywyQkFBMkI7Z0JBQzNCLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2FBQ3pCO2lCQUFNLElBQUksSUFBSSxJQUFJLEVBQUUsSUFBSSxJQUFJLEdBQUcsRUFBRSxFQUFFO2dCQUNsQyw2QkFBNkI7Z0JBQzdCLEdBQUcsR0FBRyxHQUFHLENBQUM7YUFDWDtpQkFBTTtnQkFDTCw4QkFBOEI7Z0JBQzlCLEdBQUcsR0FBRyxDQUFDLENBQUM7YUFDVDtTQUNGO1FBRUQsT0FBTyxHQUFHLEdBQUcsSUFBSSxDQUFDO0lBQ3BCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIHRpbWVyLCBvZiwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAsIHRha2UsIHRhcCwgc3RhcnRXaXRoLCBzaGFyZVJlcGxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IExvYWRpbmdCYXJDb25maWcgfSBmcm9tICcuL2xvYWRpbmctYmFyLmNvbmZpZyc7XG5cbmludGVyZmFjZSBJTG9hZGluZ0JhclN0YXRlIHtcbiAgYWN0aW9uOiAnc3RhcnQnIHwgJ2NvbXBsZXRlJyB8ICdzZXQnIHwgJ3N0b3AnIHwgJ2luY3JlbWVudCc7XG4gIHZhbHVlOiBudW1iZXI7XG4gIGluaXRpYWxWYWx1ZTogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgTG9hZGluZ0JhclN0YXRlIHtcbiAgcHJpdmF0ZSBzdGF0ZTogSUxvYWRpbmdCYXJTdGF0ZSA9IHtcbiAgICBhY3Rpb246IG51bGwsXG4gICAgdmFsdWU6IDAsXG4gICAgaW5pdGlhbFZhbHVlOiAwLFxuICB9O1xuICBwcml2YXRlIHJlcXVlc3RzID0gbnVsbDtcbiAgcHJpdmF0ZSBkaXNhYmxlZCA9IGZhbHNlO1xuICBwcml2YXRlIHJlYWRvbmx5IHN0cmVhbSQgPSBuZXcgU3ViamVjdDxJTG9hZGluZ0JhclN0YXRlPigpO1xuICBwcml2YXRlIF92YWx1ZSQ6IE9ic2VydmFibGU8bnVtYmVyPiB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY29uZmlnOiBMb2FkaW5nQmFyQ29uZmlnID0ge30pIHtcbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIGxhdGVuY3lUaHJlc2hvbGQ6IDAsXG4gICAgICAuLi5jb25maWcsXG4gICAgfTtcbiAgfVxuXG4gIGdldCB2YWx1ZSQoKSB7XG4gICAgaWYgKHRoaXMuX3ZhbHVlJCkge1xuICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlJDtcbiAgICB9XG5cbiAgICByZXR1cm4gKHRoaXMuX3ZhbHVlJCA9IHRoaXMuc3RyZWFtJC5waXBlKFxuICAgICAgc3RhcnRXaXRoKHRoaXMuc3RhdGUpLFxuICAgICAgc3dpdGNoTWFwKChzKSA9PiB0aGlzLnRpbWVyJChzKSksXG4gICAgICBzaGFyZVJlcGxheSgpLFxuICAgICAgbWFwKChzKSA9PiBzLnZhbHVlKSxcbiAgICApKTtcbiAgfVxuXG4gIHN0YXJ0KGluaXRpYWxWYWx1ZSA9IDIpIHtcbiAgICBpZiAodGhpcy5kaXNhYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMubmV4dCh7IGFjdGlvbjogJ3N0YXJ0JywgaW5pdGlhbFZhbHVlIH0pO1xuICB9XG5cbiAgc3RvcCgpIHtcbiAgICB0aGlzLm5leHQoeyBhY3Rpb246ICdzdG9wJyB9KTtcbiAgfVxuXG4gIGNvbXBsZXRlKCkge1xuICAgIHRoaXMubmV4dCh7IGFjdGlvbjogJ2NvbXBsZXRlJyB9KTtcbiAgfVxuXG4gIGRpc2FibGUoKSB7XG4gICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7XG4gIH1cblxuICBzZXQodmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMubmV4dCh7IGFjdGlvbjogJ3NldCcsIHZhbHVlIH0pO1xuICB9XG5cbiAgaW5jcmVtZW50KHZhbHVlID0gMCkge1xuICAgIHRoaXMubmV4dCh7IGFjdGlvbjogJ2luY3JlbWVudCcsIHZhbHVlIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBuZXh0KHN0YXRlOiBQYXJ0aWFsPElMb2FkaW5nQmFyU3RhdGU+LCBlbWl0RXZlbnQgPSB0cnVlKSB7XG4gICAgc3dpdGNoIChzdGF0ZS5hY3Rpb24pIHtcbiAgICAgIGNhc2UgJ3N0YXJ0JzpcbiAgICAgICAgdGhpcy5yZXF1ZXN0cyA9ICh0aGlzLnJlcXVlc3RzIHx8IDApICsgMTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdjb21wbGV0ZSc6XG4gICAgICAgIHRoaXMucmVxdWVzdHMgPSAodGhpcy5yZXF1ZXN0cyB8fCAxKSAtIDE7XG4gICAgICAgIGlmICh0aGlzLnJlcXVlc3RzID4gMCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3N0b3AnOlxuICAgICAgICB0aGlzLnJlcXVlc3RzID0gMDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdpbmNyZW1lbnQnOlxuICAgICAgICBzdGF0ZS52YWx1ZSA9IHRoaXMuX2luY3JlbWVudChzdGF0ZS52YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHRoaXMuc3RhdGUgPSB7IC4uLnRoaXMuc3RhdGUsIGFjdGlvbjogbnVsbCwgLi4uc3RhdGUgfTtcbiAgICBpZiAoZW1pdEV2ZW50KSB7XG4gICAgICB0aGlzLnN0cmVhbSQubmV4dCh0aGlzLnN0YXRlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRpbWVyJCA9IChzOiBJTG9hZGluZ0JhclN0YXRlKSA9PiB7XG4gICAgbGV0IHN0YXRlJDogT2JzZXJ2YWJsZTxQYXJ0aWFsPElMb2FkaW5nQmFyU3RhdGU+PiA9IG9mKHMpO1xuICAgIHN3aXRjaCAocy5hY3Rpb24pIHtcbiAgICAgIGNhc2UgJ3N0YXJ0JzpcbiAgICAgIGNhc2UgJ2luY3JlbWVudCc6XG4gICAgICBjYXNlICdzZXQnOiB7XG4gICAgICAgIGlmIChzLmFjdGlvbiA9PT0gJ3N0YXJ0JyAmJiB0aGlzLmNvbmZpZy5sYXRlbmN5VGhyZXNob2xkID09PSAwICYmIHMudmFsdWUgPT09IDApIHtcbiAgICAgICAgICBzLnZhbHVlID0gcy5pbml0aWFsVmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5yZXF1ZXN0cyA+IDApIHtcbiAgICAgICAgICBzdGF0ZSQgPSB0aW1lcih0aGlzLmNvbmZpZy5sYXRlbmN5VGhyZXNob2xkLCAyNTApLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHQpID0+ICh7IC4uLnMsIHZhbHVlOiB0ID09PSAwID8gdGhpcy5zdGF0ZS52YWx1ZSB8fCBzLmluaXRpYWxWYWx1ZSA6IHRoaXMuX2luY3JlbWVudCgpIH0pKSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY2FzZSAnY29tcGxldGUnOlxuICAgICAgY2FzZSAnc3RvcCc6IHtcbiAgICAgICAgLy8gQXR0ZW1wdCB0byBhZ2dyZWdhdGUgYW55IHN0YXJ0L2NvbXBsZXRlIGNhbGxzIHdpdGhpbiA1MDBtczpcbiAgICAgICAgc3RhdGUkID1cbiAgICAgICAgICBzLnZhbHVlID09PSAwXG4gICAgICAgICAgICA/IG9mKHsgLi4ucyB9KVxuICAgICAgICAgICAgOiB0aW1lcigwLCA1MDApLnBpcGUoXG4gICAgICAgICAgICAgICAgdGFrZSgyKSxcbiAgICAgICAgICAgICAgICBtYXAoKHQpID0+ICh7IHZhbHVlOiB0ID09PSAwID8gMTAwIDogMCB9KSksXG4gICAgICAgICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzdGF0ZSQucGlwZShcbiAgICAgIG1hcCgobmV4dCkgPT4gPElMb2FkaW5nQmFyU3RhdGU+eyAuLi5uZXh0LCBhY3Rpb246ICdzZXQnIH0pLFxuICAgICAgdGFwKChuZXh0KSA9PiB0aGlzLm5leHQobmV4dCwgZmFsc2UpKSxcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgX2luY3JlbWVudChybmQgPSAwKSB7XG4gICAgY29uc3Qgc3RhdCA9IHRoaXMuc3RhdGUudmFsdWU7XG4gICAgaWYgKHN0YXQgPj0gOTkpIHtcbiAgICAgIHJuZCA9IDA7XG4gICAgfVxuXG4gICAgaWYgKHJuZCA9PT0gMCkge1xuICAgICAgaWYgKHN0YXQgPj0gMCAmJiBzdGF0IDwgMjUpIHtcbiAgICAgICAgLy8gU3RhcnQgb3V0IGJldHdlZW4gMyAtIDYlIGluY3JlbWVudHNcbiAgICAgICAgcm5kID0gTWF0aC5yYW5kb20oKSAqICg1IC0gMyArIDEpICsgMztcbiAgICAgIH0gZWxzZSBpZiAoc3RhdCA+PSAyNSAmJiBzdGF0IDwgNjUpIHtcbiAgICAgICAgLy8gaW5jcmVtZW50IGJldHdlZW4gMCAtIDMlXG4gICAgICAgIHJuZCA9IE1hdGgucmFuZG9tKCkgKiAzO1xuICAgICAgfSBlbHNlIGlmIChzdGF0ID49IDY1ICYmIHN0YXQgPCA5MCkge1xuICAgICAgICAvLyBpbmNyZW1lbnQgYmV0d2VlbiAwIC0gMiVcbiAgICAgICAgcm5kID0gTWF0aC5yYW5kb20oKSAqIDI7XG4gICAgICB9IGVsc2UgaWYgKHN0YXQgPj0gOTAgJiYgc3RhdCA8IDk5KSB7XG4gICAgICAgIC8vIGZpbmFsbHksIGluY3JlbWVudCBpdCAuNSAlXG4gICAgICAgIHJuZCA9IDAuNTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGFmdGVyIDk5JSwgZG9uJ3QgaW5jcmVtZW50OlxuICAgICAgICBybmQgPSAwO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBybmQgKyBzdGF0O1xuICB9XG59XG4iXX0=